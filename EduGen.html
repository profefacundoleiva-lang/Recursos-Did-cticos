import React, { useState, useEffect, useRef } from 'react';
import { 
  BookOpen, 
  FileText, 
  BrainCircuit, 
  Layers, 
  Loader2, 
  CheckCircle2, 
  XCircle, 
  ChevronRight, 
  ChevronLeft, 
  RotateCcw,
  Sparkles,
  ChevronDown,
  Upload,
  FileCode,
  ArrowLeft,
  MessageSquare,
  Zap,
  Send,
  AlertCircle
} from 'lucide-react';

const apiKey = ""; // La clave se proporciona en el entorno de ejecución

const EduGenAI = () => {
  const [inputText, setInputText] = useState("");
  const [activeTab, setActiveTab] = useState("input");
  const [isLoading, setIsLoading] = useState(false);
  const [generatedData, setGeneratedData] = useState(null);
  const [error, setError] = useState(null);
  const [isLibsLoaded, setIsLibsLoaded] = useState(false);

  // Estados para funciones de IA
  const [chatInput, setChatInput] = useState("");
  const [chatHistory, setChatHistory] = useState([]);
  const [isAiResponding, setIsAiResponding] = useState(false);
  const [simpleExplanation, setSimpleExplanation] = useState("");

  // Estado para el Cuestionario
  const [quizAnswers, setQuizAnswers] = useState({});
  const [quizSubmitted, setQuizSubmitted] = useState(false);

  // Estado para las Flashcards
  const [currentFlashcardIndex, setCurrentFlashcardIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);

  const chatEndRef = useRef(null);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatHistory]);

  // Carga de bibliotecas externas para PDF y DOCX
  useEffect(() => {
    const loadScripts = async () => {
      const scripts = [
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"
      ];

      for (const src of scripts) {
        if (!document.querySelector(`script[src="${src}"]`)) {
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          document.head.appendChild(script);
        }
      }
      setIsLibsLoaded(true);
    };
    loadScripts();
  }, []);

  const fetchGemini = async (prompt, systemInstruction, isJson = true) => {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: systemInstruction }] },
      generationConfig: isJson ? { responseMimeType: "application/json" } : {}
    };

    const fetchWithRetry = async (retries = 5, delay = 1000) => {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          if (retries > 0 && response.status === 429) {
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(retries - 1, delay * 2);
          }
          throw new Error("Error en la respuesta del servidor");
        }

        const data = await response.json();
        const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        return isJson ? JSON.parse(textResponse) : textResponse;
      } catch (err) {
        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, delay));
          return fetchWithRetry(retries - 1, delay * 2);
        }
        throw err;
      }
    };

    return fetchWithRetry();
  };

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setIsLoading(true);
    setError(null);

    try {
      if (file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const typedarray = new Uint8Array(event.target.result);
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            const loadingTask = pdfjsLib.getDocument({ data: typedarray });
            const pdf = await loadingTask.promise;

            if (pdf.numPages > 15) {
              throw new Error("El documento excede el límite de 15 páginas.");
            }
            
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(" ");
              fullText += pageText + "\n";
            }
            
            if (fullText.trim().length === 0) {
              throw new Error("El PDF parece no tener texto legible (posiblemente imagen sin OCR).");
            }

            setInputText(fullText);
            setIsLoading(false);
          } catch (err) {
            setError(err.message);
            setIsLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const result = await window.mammoth.extractRawText({ arrayBuffer: event.target.result });
            setInputText(result.value);
            setIsLoading(false);
          } catch (err) {
            setError("Error al leer Word (.docx)");
            setIsLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        const reader = new FileReader();
        reader.onload = (event) => { 
          setInputText(event.target.result); 
          setIsLoading(false); 
        };
        reader.readAsText(file);
      }
    } catch (err) {
      setError("No se pudo cargar el archivo.");
      setIsLoading(false);
    }
  };

  const generateMaterial = async (type) => {
    if (!inputText.trim()) { setError("Carga un texto primero."); return; }
    setIsLoading(true);
    setError(null);
    let systemPrompt = "";
    if (type === 'reading') systemPrompt = "Crea 5 ejercicios de comprensión lectora. JSON: {exercises: [{question, hint}]}.";
    else if (type === 'quiz') systemPrompt = "Crea quiz de 5 preguntas. JSON: {questions: [{id, question, options, correctIndex}]}.";
    else if (type === 'flashcards') systemPrompt = "Genera 8 flashcards. JSON: {cards: [{front, back}]}.";
    try {
      const result = await fetchGemini(`Texto: ${inputText.substring(0, 10000)}`, systemPrompt);
      setGeneratedData({ type, data: result });
      setActiveTab(type);
    } catch (err) { setError("Error de generación."); }
    finally { setIsLoading(false); }
  };

  const explainSimply = async () => {
    if (!inputText.trim()) return;
    setIsAiResponding(true);
    try {
      const response = await fetchGemini(
        `Texto a explicar: ${inputText.substring(0, 5000)}`,
        "Eres un tutor experto. Explica los puntos clave del texto de forma extremadamente sencilla, como si se lo explicaras a un niño de 10 años. Usa analogías. Máximo 200 palabras.",
        false
      );
      setSimpleExplanation(response);
    } catch (err) {
      setSimpleExplanation("No pude simplificar el texto en este momento.");
    } finally {
      setIsAiResponding(false);
    }
  };

  const askAi = async () => {
    if (!chatInput.trim() || !inputText.trim()) return;
    const userMsg = { role: 'user', text: chatInput };
    setChatHistory(prev => [...prev, userMsg]);
    setChatInput("");
    setIsAiResponding(true);

    try {
      const response = await fetchGemini(
        `Pregunta del usuario: ${chatInput}\n\nContexto del documento: ${inputText.substring(0, 8000)}`,
        "Eres un tutor de IA asistente. Responde preguntas basadas estrictamente en el texto proporcionado. Si la respuesta no está en el texto, indícalo cortésmente. Sé conciso y amable.",
        false
      );
      setChatHistory(prev => [...prev, { role: 'ai', text: response }]);
    } catch (err) {
      setChatHistory(prev => [...prev, { role: 'ai', text: "Lo siento, tuve un problema al procesar tu pregunta." }]);
    } finally {
      setIsAiResponding(false);
    }
  };

  const renderContent = () => {
    if (isLoading) return (
      <div className="flex flex-col items-center justify-center py-20 px-6 text-center space-y-6">
        <Loader2 className="w-12 h-12 text-blue-600 animate-spin" />
        <p className="text-xl font-bold text-slate-800">Procesando Documento...</p>
        <p className="text-xs text-slate-400">Extrayendo texto para tu estudio</p>
      </div>
    );

    if (activeTab === 'assistant') return (
      <div className="space-y-6 animate-in fade-in duration-500 pb-20">
        <header className="flex items-center gap-3">
          <div className="p-2 bg-indigo-100 rounded-lg"><Sparkles className="text-indigo-600 w-5 h-5" /></div>
          <h2 className="text-xl font-bold text-slate-800">Tutor Personal ✨</h2>
        </header>

        <div className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-3xl border border-indigo-100 shadow-sm space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-indigo-900 flex items-center gap-2 text-sm">
              <Zap className="w-4 h-4" /> Explicación Simple ✨
            </h3>
            <button 
              onClick={explainSimply}
              disabled={isAiResponding}
              className="px-4 py-2 bg-indigo-600 text-white text-[10px] font-black uppercase tracking-wider rounded-xl hover:bg-indigo-700 disabled:opacity-50 transition-all shadow-md shadow-indigo-100"
            >
              {isAiResponding ? '...' : 'Generar'}
            </button>
          </div>
          {simpleExplanation && (
            <div className="text-sm text-slate-700 leading-relaxed bg-white/60 p-4 rounded-2xl border border-white italic">
              {simpleExplanation}
            </div>
          )}
        </div>

        <div className="bg-white rounded-3xl border border-slate-100 shadow-lg flex flex-col h-[400px] overflow-hidden">
          <div className="p-4 border-b border-slate-50 bg-slate-50/50 flex items-center gap-2">
            <MessageSquare className="w-4 h-4 text-slate-400" />
            <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Preguntas al Doc</span>
          </div>
          
          <div className="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
            {chatHistory.length === 0 && (
              <p className="text-slate-400 text-xs text-center p-6">Pregúntame cualquier cosa sobre el texto cargado.</p>
            )}
            {chatHistory.map((msg, i) => (
              <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] p-3 rounded-2xl text-xs ${
                  msg.role === 'user' ? 'bg-slate-800 text-white rounded-tr-none' : 'bg-slate-100 text-slate-800 rounded-tl-none border border-slate-200'
                }`}>
                  {msg.text}
                </div>
              </div>
            ))}
            {isAiResponding && <div className="animate-pulse text-xs text-slate-400 px-2">Gemini está pensando...</div>}
            <div ref={chatEndRef} />
          </div>

          <div className="p-3 border-t border-slate-100 bg-white">
            <div className="relative flex items-center">
              <input 
                value={chatInput}
                onChange={(e) => setChatInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && askAi()}
                placeholder="Escribe tu duda..."
                className="w-full pl-4 pr-10 py-2.5 bg-slate-50 rounded-xl border-none text-xs outline-none"
              />
              <button onClick={askAi} className="absolute right-1.5 p-1.5 bg-indigo-600 text-white rounded-lg"><Send className="w-3.5 h-3.5" /></button>
            </div>
          </div>
        </div>
      </div>
    );

    if (generatedData?.type === 'reading') return (
      <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-300">
        <header className="flex items-center gap-3 mb-2">
          <div className="p-2 bg-blue-100 rounded-lg"><BookOpen className="text-blue-600 w-5 h-5" /></div>
          <h2 className="text-lg font-bold text-slate-800">Comprensión Lectora</h2>
        </header>
        {generatedData.data.exercises?.map((ex, i) => (
          <div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
            <p className="font-bold text-slate-700 text-sm mb-3">{i + 1}. {ex.question}</p>
            <textarea className="w-full p-3 bg-slate-50 border-none rounded-xl text-xs outline-none" placeholder="Tu respuesta..." rows={3} />
            <details className="mt-2">
              <summary className="text-[10px] font-black text-blue-600 uppercase cursor-pointer">Ver Pista</summary>
              <p className="mt-2 text-xs text-slate-500 italic bg-blue-50/50 p-2 rounded-lg">{ex.hint}</p>
            </details>
          </div>
        ))}
      </div>
    );

    if (generatedData?.type === 'quiz') return (
       <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-300 pb-20">
          <header className="flex items-center gap-3">
            <div className="p-2 bg-purple-100 rounded-lg"><BrainCircuit className="text-purple-600 w-5 h-5" /></div>
            <h2 className="text-lg font-bold text-slate-800">Quiz Rápido</h2>
          </header>
          {generatedData.data.questions?.map((q, qIdx) => (
            <div key={qIdx} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
              <p className="font-bold text-slate-800 text-sm mb-4">{q.question}</p>
              <div className="space-y-2">
                {q.options.map((option, oIdx) => (
                  <button
                    key={oIdx}
                    onClick={() => setQuizAnswers({...quizAnswers, [qIdx]: oIdx})}
                    className={`w-full p-3 text-left rounded-xl border-2 text-xs transition-all ${quizAnswers[qIdx] === oIdx ? 'border-purple-500 bg-purple-50 font-bold' : 'border-slate-50 bg-slate-50'}`}
                  >
                    {option}
                  </button>
                ))}
              </div>
            </div>
          ))}
          <button className="fixed bottom-6 left-6 right-6 py-4 bg-purple-600 text-white font-bold rounded-2xl shadow-xl shadow-purple-200">
            Calificar con IA
          </button>
       </div>
    );

    if (generatedData?.type === 'flashcards') {
      const card = generatedData.data.cards[currentFlashcardIndex];
      const progress = ((currentFlashcardIndex + 1) / generatedData.data.cards.length) * 100;
      return (
        <div className="flex flex-col h-full space-y-6 animate-in zoom-in-95 duration-300">
          <header className="flex items-center gap-3">
            <div className="p-2 bg-orange-100 rounded-lg"><Layers className="text-orange-600 w-5 h-5" /></div>
            <h2 className="text-lg font-bold text-slate-800">Memorización</h2>
          </header>
          <div className="perspective-1000 h-80 w-full cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
            <div className={`relative w-full h-full transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
              <div className="absolute inset-0 backface-hidden bg-white rounded-[2rem] shadow-xl border-2 border-orange-50 flex flex-col items-center justify-center p-6 text-center">
                <p className="text-xl font-bold text-slate-800">{card.front}</p>
                <p className="mt-6 text-slate-300 text-[10px] font-black uppercase tracking-widest">Toca para revelar</p>
              </div>
              <div className="absolute inset-0 backface-hidden bg-orange-600 rounded-[2rem] shadow-xl flex flex-col items-center justify-center p-6 text-center text-white rotate-y-180">
                <p className="text-base font-medium leading-relaxed">{card.back}</p>
              </div>
            </div>
          </div>
          <div className="space-y-4">
            <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
              <div className="bg-orange-500 h-full transition-all duration-300" style={{ width: `${progress}%` }} />
            </div>
            <div className="flex gap-3">
              <button disabled={currentFlashcardIndex === 0} onClick={() => {setCurrentFlashcardIndex(p => p - 1); setIsFlipped(false);}} className="flex-1 py-3 bg-white border border-slate-200 rounded-2xl flex items-center justify-center disabled:opacity-30"><ChevronLeft /></button>
              <button disabled={currentFlashcardIndex === generatedData.data.cards.length - 1} onClick={() => {setCurrentFlashcardIndex(p => p + 1); setIsFlipped(false);}} className="flex-[2] py-3 bg-slate-800 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg disabled:opacity-30">Siguiente <ChevronRight /></button>
            </div>
          </div>
        </div>
      );
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100">
      <style>{`
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
      `}</style>

      <div className="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl overflow-hidden relative border-x border-slate-100">
        <header className="pt-6 pb-4 px-6 sticky top-0 bg-white/90 backdrop-blur-md z-10 border-b border-slate-50">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="bg-blue-600 p-1.5 rounded-xl shadow-lg shadow-blue-100">
                <Sparkles className="text-white w-4 h-4" />
              </div>
              <h1 className="text-xl font-black text-slate-800 tracking-tight">EduGen <span className="text-blue-600">AI</span></h1>
            </div>
            {activeTab !== "input" && !isLoading && (
              <button onClick={() => setActiveTab("input")} className="p-2 text-slate-400 hover:bg-slate-50 rounded-lg"><ArrowLeft className="w-5 h-5" /></button>
            )}
          </div>
        </header>

        <main className="flex-1 p-6 overflow-y-auto">
          {activeTab === "input" ? (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="space-y-1">
                <h2 className="text-2xl font-black text-slate-800">Estudia con IA</h2>
                <p className="text-xs text-slate-500 font-medium">Extrae texto de PDF o DOCX automáticamente.</p>
                <p className="text-[10px] text-amber-600 font-bold leading-tight mt-1 flex items-start gap-1">
                  <AlertCircle className="w-3 h-3 flex-shrink-0 mt-0.5" />
                  <span>Solo puedes colocar documentos de máximo 15 páginas y formatos pdf con texto legible (OCR).</span>
                </p>
              </div>

              <div className="flex gap-2">
                <label className="flex-1 flex items-center justify-center gap-2 px-4 py-4 bg-slate-900 text-white rounded-[1.5rem] cursor-pointer active:scale-95 transition-all text-xs font-bold shadow-xl shadow-slate-200">
                  <FileCode className="w-4 h-4 text-blue-400" /> Cargar Documento
                  <input type="file" accept=".pdf,.docx,.txt" onChange={handleFileUpload} className="hidden" />
                </label>
              </div>

              <div className="relative">
                <textarea
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  placeholder="El texto de tu documento aparecerá aquí después de cargarlo, también puedes copiar y pegar o simplemente escribir de forma manual..."
                  className="w-full h-48 p-5 rounded-[2rem] bg-slate-50 border-none focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none transition-all text-sm leading-relaxed text-slate-700 shadow-inner"
                />
                <div className="absolute top-4 right-4 text-[9px] font-black text-slate-300 uppercase tracking-widest">{inputText.length} CARS</div>
              </div>

              {error && <div className="p-4 bg-red-50 text-red-600 rounded-2xl text-[10px] font-bold border border-red-100 animate-pulse flex gap-2 items-center"><XCircle className="w-4 h-4" /> {error}</div>}

              {/* Contenedor de botones en columna */}
              <div className="flex flex-col gap-3">
                <button onClick={() => setActiveTab('assistant')} disabled={!inputText || isLoading} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-100 disabled:opacity-30 active:scale-95 transition-transform">
                  <Sparkles className="w-4 h-4" /> Asistente Tutor ✨
                </button>
                
                <button onClick={() => generateMaterial('reading')} disabled={!inputText || isLoading} className="w-full p-4 bg-white border border-slate-100 rounded-2xl flex items-center gap-4 active:bg-blue-50 transition-colors shadow-sm disabled:opacity-30">
                  <div className="bg-blue-50 p-2 rounded-lg flex-shrink-0"><BookOpen className="text-blue-600 w-5 h-5" /></div>
                  <span className="text-xs font-bold text-slate-600">Lecto-comprensión</span>
                </button>

                <button onClick={() => generateMaterial('quiz')} disabled={!inputText || isLoading} className="w-full p-4 bg-white border border-slate-100 rounded-2xl flex items-center gap-4 active:bg-purple-50 transition-colors shadow-sm disabled:opacity-30">
                  <div className="bg-purple-50 p-2 rounded-lg flex-shrink-0"><BrainCircuit className="text-purple-600 w-5 h-5" /></div>
                  <span className="text-xs font-bold text-slate-600">Quiz</span>
                </button>

                <button onClick={() => generateMaterial('flashcards')} disabled={!inputText || isLoading} className="w-full p-4 bg-white border border-slate-100 rounded-2xl flex items-center gap-4 active:bg-orange-50 transition-colors shadow-sm disabled:opacity-30">
                  <div className="bg-orange-50 p-2 rounded-lg flex-shrink-0"><Layers className="text-orange-600 w-5 h-5" /></div>
                  <span className="text-xs font-bold text-slate-600">Flashcards</span>
                </button>
              </div>
            </div>
          ) : (
            <div className="h-full">
               {renderContent()}
            </div>
          )}
        </main>

        <footer className="p-6 text-center border-t border-slate-50">
          <p className="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">EduGen AI • Powered by Gemini</p>
        </footer>
      </div>
    </div>
  );
};

export default EduGenAI;